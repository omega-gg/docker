#!/bin/bash
set -e

#--------------------------------------------------------------------------------------------------
# Settings
#--------------------------------------------------------------------------------------------------

artifact="733"

source="https://dev.azure.com/bunjee/docker/_apis/build/builds/$artifact/artifacts"

#--------------------------------------------------------------------------------------------------
# Functions
#--------------------------------------------------------------------------------------------------

function getSource
{
    curl -L -o artifacts.json $1

    artifacts=$(cat artifacts.json)

    rm artifacts.json

    echo $artifacts | $grep -Po '"id":.*?[^\\]}}'         | \
                      $grep $2                            | \
                      $grep -Po '"downloadUrl":.*?[^\\]"' | \
                      $grep -o '"[^"]*"$'                 | tr -d '"'
}

#--------------------------------------------------------------------------------------------------
# Syntax
#--------------------------------------------------------------------------------------------------

if [ $# != 1 ] || [ $1 != "debian-vlc-android" ]; then

    echo "Usage: load <debian-vlc-android>"

    exit 1
fi

#--------------------------------------------------------------------------------------------------
# Configuration
#--------------------------------------------------------------------------------------------------
# NOTE: We use ggrep on macOS because it supports Perl regexp.

if [[ "$OSTYPE" == "darwin"* ]]; then

    brew install grep

    grep="ggrep"
else
    grep="grep"
fi

#--------------------------------------------------------------------------------------------------
# Artifact
#--------------------------------------------------------------------------------------------------

echo "ARTIFACT $1"
echo $source

source=$(getSource $source $1)

echo ""
echo "DOWNLOADING $1"
echo $source

curl -L -o artifact.zip $source

echo ""
echo "EXTRACTING $1"

unzip -q artifact.zip

rm artifact.zip

#--------------------------------------------------------------------------------------------------
# Load
#--------------------------------------------------------------------------------------------------

echo ""
echo "LOADING $1"

docker load < $1.tar

rm $1.tar
